<div class="market-analysis-container">
  <!-- Debug info -->
  <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc;">
    <strong>Debug Info:</strong><br>
    Signals count: {{signals.length}}<br>
    Loading: {{loadingSignals}}<br>
    Symbol: {{symbol}}<br>
    Technical Indicators: {{technicalIndicators ? 'Loaded' : 'Not loaded'}}<br>
    Forecast: {{forecast ? 'Loaded' : 'Not loaded'}}
  </div>
  
  <!-- Alert tín hiệu mới -->
  <div *ngIf="alertMessage" class="signal-alert">
    <i class="fas fa-bell"></i>
    <span>{{ alertMessage }}</span>
  </div>
  <!-- Phần chỉ số kỹ thuật -->
  <div class="technical-indicators-section">
    <h3 class="section-title">
      <i class="fas fa-chart-line"></i>
      Chỉ số Kỹ thuật
    </h3>
    <div class="indicators-grid">
      <div class="indicator-card">
        <div class="indicator-label">RSI</div>
        <div class="indicator-value" *ngIf="technicalIndicators" [style.color]="technicalIndicators.rsi > 70 ? '#ef4444' : technicalIndicators.rsi < 30 ? '#10b981' : '#6b7280'">
          {{technicalIndicators.rsi.toFixed(2)}}
        </div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
        <div class="indicator-status" *ngIf="technicalIndicators">
          <span *ngIf="technicalIndicators.rsi > 70" class="status overbought">Quá mua</span>
          <span *ngIf="technicalIndicators.rsi < 30" class="status oversold">Quá bán</span>
          <span *ngIf="technicalIndicators.rsi >= 30 && technicalIndicators.rsi <= 70" class="status neutral">Trung tính</span>
        </div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">EMA 20</div>
        <div class="indicator-value" *ngIf="technicalIndicators">{{formatPrice(technicalIndicators.ema20)}}</div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">EMA 50</div>
        <div class="indicator-value" *ngIf="technicalIndicators">{{formatPrice(technicalIndicators.ema50)}}</div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">MACD</div>
        <div class="indicator-value" *ngIf="technicalIndicators" [style.color]="technicalIndicators.macd > 0 ? '#10b981' : '#ef4444'">
          {{technicalIndicators.macd.toFixed(4)}}
        </div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">MACD Signal</div>
        <div class="indicator-value" *ngIf="technicalIndicators">{{technicalIndicators.macdSignal.toFixed(4)}}</div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">MACD Histogram</div>
        <div class="indicator-value" *ngIf="technicalIndicators" [style.color]="technicalIndicators.macdHistogram > 0 ? '#10b981' : '#ef4444'">
          {{technicalIndicators.macdHistogram.toFixed(4)}}
        </div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>

      <div class="indicator-card">
        <div class="indicator-label">ATR</div>
        <div class="indicator-value" *ngIf="technicalIndicators">{{technicalIndicators.atr.toFixed(4)}}</div>
        <div class="indicator-value" *ngIf="!technicalIndicators">—</div>
      </div>
    </div>
  </div>

  <!-- Phần dự báo xu thế ngắn hạn -->
  <div class="forecast-section" *ngIf="forecast">
    <h3 class="section-title">
      <i class="fas fa-magic"></i>
      Dự báo xu thế gần
    </h3>
    <div class="forecast-card">
      <div class="forecast-controls">
        <label>Phạm vi (ngày):
          <select [(ngModel)]="forecastHorizon" (change)="loadForecast()">
            <option [ngValue]="1">1</option>
            <option [ngValue]="3">3</option>
            <option [ngValue]="5">5</option>
            <option [ngValue]="7">7</option>
          </select>
        </label>
      </div>
      <div class="forecast-row">
        <div>
          <span>Hướng:</span>
          <strong [style.color]="forecast.direction === 'UP' ? '#10b981' : forecast.direction === 'DOWN' ? '#ef4444' : '#6b7280'">
            {{forecast.direction === 'UP' ? 'TĂNG' : forecast.direction === 'DOWN' ? 'GIẢM' : 'TRUNG TÍNH'}}
          </strong>
        </div>
        <div><span>Độ tin cậy:</span> <strong>{{forecast.confidence.toFixed(1)}}%</strong></div>
        <div><span>Mục tiêu {{forecast.horizonDays}} ngày:</span> <strong>{{formatPrice(forecast.targetPrice)}}</strong></div>
      </div>
      <div class="forecast-summary">{{forecast.summary}}</div>
    </div>
  </div>

  <!-- Phần tín hiệu giao dịch -->
  <div class="signals-section">
    <h3 class="section-title">
      <i class="fas fa-signal"></i>
      Tín hiệu Giao dịch ({{signals.length}} tín hiệu)
    </h3>
    
    <div class="signals-table-container">
      <table class="signals-table">
        <thead>
          <tr>
            <th>Thời gian</th>
            <th>RSI</th>
            <th>Nền tảng</th>
            <th>Xu hướng</th>
            <th>Điểm đảo chiều</th>
            <th>Lệnh</th>
            <th>Giá</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="signals.length === 0" class="no-data-row">
            <td colspan="7" class="no-data">Không có tín hiệu cho {{symbol || 'sàn này'}} (Debug: signals.length = {{signals.length}})</td>
          </tr>
          <tr *ngFor="let signal of signals; let i = index" class="signal-row">
            <td class="timestamp">{{formatShortTime(signal.createdAt || signal.timestamp)}}</td>
            <td class="rsi">
              <ng-container *ngIf="signal.rsi !== undefined && signal.rsi !== null; else noRsi">
                {{signal.rsi | number:'1.0-1'}}
              </ng-container>
              <ng-template #noRsi>—</ng-template>
            </td>
            <td class="platform">{{getPlatformName(signal)}}</td>
            <td class="trend">
              <span class="signal-badge" [style.background-color]="getSignalColor(signal.signalType)">
                {{getSignalTypeLabel(signal.signalType)}}
              </span>
            </td>
            <td class="reversal-point">{{getReversalPointDisplay(signal)}}</td>
            <td class="action" [style.color]="getSignalColor(signal.signalType)">
              {{getSignalTypeLabel(signal.signalType)}}
            </td>
            <td class="price">{{formatPrice(signal.price)}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
